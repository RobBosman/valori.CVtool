# ubuntu 20.04 - 37.97.242.249 / cvtool.bransom.nl / vcv01.valori.nl
apt-get -y update
apt-get -y upgrade

apt-get -y install fail2ban

# Configure firewall.
# Whitelist IP-numbers for SSH:
#   85.146.18.88/32 (Rob thuis)
#   157.97.115.136/29 (Valori kantoor)
#   145.131.215.232/29 (Skyliner kantoor, daar zit Luke vaak)
#   2a02:22a0:bbb6:1602::/64 (Skyliner kantoor IPv6)
apt-get -y install ufw
ufw default deny incoming
ufw default allow outgoing
ufw allow from 85.146.18.88/32 to any port 22
ufw allow from 157.97.115.136/29 to any port 22
ufw allow from 145.131.215.232/29 to any port 22
ufw allow from 2a02:22a0:bbb6:1602::/64 to any port 22
ufw allow 443/tcp
ufw allow 80/tcp
ufw allow from 85.146.18.88 to any port 27017
ufw enable

# Install Docker.
apt-get -y install docker.io
systemctl enable --now docker
usermod -aG docker rbosman

# Install docker-compose.
curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

docker login -u bransom
# remove pwd form /root/.docker/config.json

# Install MongoDB and CVtool app.
docker-compose --env-file=/secret/.env up -d


echo "<html><body>.well-known/acme-challenge/</body></html?" > /var/lib/docker/volumes/root_webroot/index.html

docker run -it --rm \
  --mount source=root_ssl_certs,target=/ssl_certs \
  --mount source=root_webroot,target=/webroot,readonly \
  --name cvtool \
  bransom/cvtool  \
  sh


# Fetch LetsEncrypt certificate
docker run -it --rm \
  -v root_ssl_certs:/etc/letsencrypt/live \
  -v root_webroot:/data/letsencrypt/.well-known/acme-challenge \
  -v letsencrypt_logs:/var/log/letsencrypt \
  certbot/certbot \
  certonly --webroot \
  --register-unsafely-without-email \
  --agree-tos \
  --webroot-path=/data/letsencrypt \
  --staging \
  -d cvtool.bransom.nl

docker run -it --rm \
  --mount source=root_ssl_certs,target=/etc/letsencrypt \
  --mount source=root_webroot,target=/data/letsencrypt \
  --name certbot \
  certbot/certbot  \
  certonly \
  --register-unsafely-without-email \
  --agree-tos \
  --webroot --webroot-path=/data/letsencrypt \
  --staging \
  -d vcv01.valori.nl


# remove containers
docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
# prune
docker network prune -f
docker rmi -f $(docker images --filter dangling=true -qa)
# armageddon
docker volume rm $(docker volume ls --filter dangling=true -q)
docker rmi -f $(docker images -qa)
